<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TAP-TAP RIALO</title>
  <style>
    :root { --bg:#0b0e12; --fg:#e7edf5; --accent:#ffd034; --danger:#ff5555; }
    html,body{
      margin:0;padding:0;height:100%;background:#000;color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      overflow:hidden;touch-action:none;-webkit-user-select:none;user-select:none;
    }
    /* Mengatur game agar selalu di tengah */
    #wrap{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
    }
    canvas{
      background:#0b0e12;
      image-rendering:crisp-edges;
      image-rendering:pixelated;
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <div id="wrap"><canvas id="game" width="720" height="1280"></canvas></div>
  <script>
    (function(){
      const LOGICAL_W=720, LOGICAL_H=1280;
      const ASSETS_PATH="./";

      const ASSETS={
        cover:"cover-bg.png",
        bg:"bg-game.png",
        startBtn:"btn-start.png",
        tryBtn:"btn-tryagain.png",
        exitBtn:"btn-exit.png",
        coinIdle:"coin.png",
        coinFlip:"flip-coin.png",
        bombIdle:"bomb.png",
        bombFlip:"flip-bomb.png"
      };

      const BGM_FILE="bgm.mp3";

      const STATES={COVER:0, PLAY:1, GAMEOVER:2};
      const GAME_TIME=30, START_LIVES=3;

      const canvas=document.getElementById('game');
      const ctx=canvas.getContext('2d');

      function fitCanvas(){
        const dpr=Math.max(1,window.devicePixelRatio||1);
        const vw=innerWidth, vh=innerHeight;
        const scale=Math.min(vw/LOGICAL_W, vh/LOGICAL_H);
        canvas.style.width=(LOGICAL_W*scale|0)+"px";
        canvas.style.height=(LOGICAL_H*scale|0)+"px";
        canvas.width=(LOGICAL_W*dpr|0);
        canvas.height=(LOGICAL_H*dpr|0);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      addEventListener('resize', fitCanvas);

      const now=()=>performance.now();
      const rand=(a,b)=>a+Math.random()*(b-a);
      function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=ASSETS_PATH+src;});}

      const images={}, bgm=new Audio(ASSETS_PATH+BGM_FILE);
      bgm.loop=true; bgm.volume=0.35;

      async function preload(){
        await Promise.all(Object.entries(ASSETS).map(async([k,v])=>images[k]=await loadImage(v)));
      }

      class ImageButton{
        constructor(img,x,y){this.img=img;this.x=x;this.y=y;this.scale=1;this.w=img.naturalWidth;this.h=img.naturalHeight;}
        draw(){const w=this.w*this.scale,h=this.h*this.scale;ctx.drawImage(this.img,this.x-w/2,this.y-h/2,w,h);}
        hit(px,py){const w=this.w*this.scale,h=this.h*this.scale;return px>=this.x-w/2&&px<=this.x+w/2&&py>=this.y-h/2&&py<=this.y+h/2;}
      }

      class Falling{
        constructor(type,x,spd){
          this.type=type; this.x=x; this.y=-80; this.vy=spd; this.r=64; this.alive=true;
          this.spawnTime=now();
          this.idleImg=(type==='coin')?images.coinIdle:images.bombIdle;
          this.flipImg=(type==='coin')?images.coinFlip:images.bombFlip;
          this.flipCols=3; this.flipFPS=10;
        }
        getFrame(){
          const t=now()-this.spawnTime;
          if(t<150) return {img:this.idleImg,sx:0,sy:0,sw:this.idleImg.naturalWidth,sh:this.idleImg.naturalHeight};
          const frame=Math.floor((t-150)/(1000/this.flipFPS))%this.flipCols;
          const sw=this.flipImg.naturalWidth/this.flipCols, sh=this.flipImg.naturalHeight;
          return {img:this.flipImg,sx:frame*sw,sy:0,sw,sh};
        }
        update(dt){
          this.y+=this.vy*dt;
          if(this.y-this.r>LOGICAL_H){
            this.alive=false;
            if(this.type === 'coin') {
              lives=Math.max(0,lives-1);
            }
          }
        }
        draw(){ const f=this.getFrame(); const size=128; ctx.drawImage(f.img,f.sx,f.sy,f.sw,f.sh,this.x-size/2,this.y-size/2,size,size); }
        contains(px,py){ const dx=px-this.x, dy=py-this.y; return dx*dx+dy*dy<=this.r*this.r; }
      }

      let state=STATES.COVER, startBtn, tryBtn, exitBtn;
      let objects=[], score=0, lives=START_LIVES, timer=0;
      let lastTs=0, spawnAccum=0, spawnRate=0.9, speed=320, running=false;

      function resetGame(){
        objects=[]; score=0; lives=START_LIVES; timer=0;
        spawnAccum=0; spawnRate=0.9; speed=320; lastTs=now(); running=true;
        try{ bgm.currentTime=0; bgm.play(); }catch{}
      }
      function stopMusic(){ try{ bgm.pause(); }catch{} }

      function localPoint(ev){
        const r=canvas.getBoundingClientRect();
        const sx=LOGICAL_W/r.width, sy=LOGICAL_H/r.height;
        const c = ev.touches? ev.touches[0] : ev;
        return { x:(c.clientX-r.left)*sx, y:(c.clientY-r.top)*sy };
      }

      function onPointerDown(ev){
        const p=localPoint(ev);
        if(state===STATES.COVER){
          if(startBtn && startBtn.hit(p.x,p.y)){ state=STATES.PLAY; resetGame(); ev.preventDefault(); return; }
        }else if(state===STATES.PLAY){
          for(let i=objects.length-1;i>=0;i--){
            const o=objects[i];
            if(o.contains(p.x,p.y)){
              if(o.type==='coin'){ score+=1; } else { lives=Math.max(0,lives-1); }
              o.alive=false;
              if(lives<=0){ state=STATES.GAMEOVER; running=false; stopMusic(); }
              ev.preventDefault(); return;
            }
          }
        }else if(state===STATES.GAMEOVER){
          if(tryBtn && tryBtn.hit(p.x,p.y)){ state=STATES.PLAY; resetGame(); ev.preventDefault(); return; }
          if(exitBtn && exitBtn.hit(p.x,p.y)){
            // Perbaikan: Kembali ke halaman awal
            window.location.href = window.location.origin + window.location.pathname;
            ev.preventDefault(); return;
          }
        }
      }
      canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
      canvas.addEventListener('touchstart', onPointerDown, {passive:false});

      function spawnOne(){
        const margin=64, x=rand(margin, LOGICAL_W-margin);
        const type=(Math.random()<0.8)?'coin':'bomb';
        const obj=new Falling(type,x,rand(speed*0.9,speed*1.2));
        objects.push(obj);
      }

      function updatePlay(dt){
        speed += dt*6;
        spawnRate = Math.max(0.4, spawnRate - dt*0.01);
        timer += dt;
        
        spawnAccum += dt;
        while(spawnAccum>=spawnRate){ spawnAccum-=spawnRate; spawnOne(); }

        for(const o of objects) o.update(dt);
        objects = objects.filter(o=>o.alive && o.y - o.r <= LOGICAL_H+2);

        if(lives<=0){ state=STATES.GAMEOVER; running=false; stopMusic(); }
      }

      function drawCover(){
        const bg=images.cover;
        const s=Math.max(LOGICAL_W/bg.naturalWidth, LOGICAL_H/bg.naturalHeight);
        const w=bg.naturalWidth*s, h=bg.naturalHeight*s;
        ctx.drawImage(bg,(LOGICAL_W-w)/2,(LOGICAL_H-h)/2,w,h);

        if(!startBtn){
          startBtn=new ImageButton(images.startBtn, LOGICAL_W/2, LOGICAL_H*0.8);
          startBtn.scale=Math.min(520, LOGICAL_W*0.7)/images.startBtn.naturalWidth;
        }
        startBtn.draw();
      }

      function drawHUD(){
        ctx.save();
        ctx.font="bold 36px system-ui,-apple-system,Segoe UI,Roboto";
        ctx.textAlign="right";
        ctx.fillStyle="#000a"; ctx.fillRect(LOGICAL_W-240,20,220,80);
        ctx.fillStyle="#fff"; ctx.fillText(`$ RIALO: ${score}`, LOGICAL_W-30, 60);
        
        const r=14,g=10,sx=LOGICAL_W-200,sy=90;
        for(let i=0;i<START_LIVES;i++){
          ctx.beginPath(); ctx.arc(sx+i*(r*2+g), sy, r, 0, Math.PI*2);
          ctx.fillStyle = (i<lives) ? "#ff4040" : "#444"; ctx.fill();
        }
        
        ctx.textAlign="center";
        ctx.fillStyle="#000a"; ctx.fillRect(LOGICAL_W/2-110,20,220,64);
        ctx.fillStyle="#fff"; ctx.font="bold 44px system-ui,-apple-system,Segoe UI,Roboto";
        ctx.fillText(`${Math.floor(timer)}s`, LOGICAL_W/2, 68);
        ctx.restore();
      }

      function drawPlay(){
        const bg=images.bg;
        const s=Math.max(LOGICAL_W/bg.naturalWidth, LOGICAL_H/bg.naturalHeight);
        const w=bg.naturalWidth*s, h=bg.naturalHeight*s;
        ctx.drawImage(bg,(LOGICAL_W-w)/2,(LOGICAL_H-h)/2,w,h);
        for(const o of objects) o.draw();
        drawHUD();
      }

      function drawGameOver(){
        drawPlay();
        ctx.fillStyle="rgba(0,0,0,0.55)"; ctx.fillRect(0,0,LOGICAL_W,LOGICAL_H);

        const pw=540, ph=420, px=(LOGICAL_W-pw)/2, py=(LOGICAL_H-ph)/2;
        ctx.fillStyle="#12161c"; ctx.strokeStyle="#ffffff22"; ctx.lineWidth=2;
        ctx.fillRect(px,py,pw,ph); ctx.strokeRect(px,py,pw,ph);
        ctx.fillStyle="#fff"; ctx.textAlign="center";
        ctx.font="700 54px system-ui,-apple-system,Segoe UI,Roboto";
        ctx.fillText("Game Over", LOGICAL_W/2, py+80);
        ctx.font="700 36px system-ui,-apple-system,Segoe UI,Roboto";
        ctx.fillText(`$ RIALO terkumpul: ${score}`, LOGICAL_W/2, py+140);

        if(!tryBtn){
          tryBtn=new ImageButton(images.tryBtn, LOGICAL_W/2, LOGICAL_H/2+20);
          tryBtn.scale=Math.min(520, LOGICAL_W*0.7)/images.tryBtn.naturalWidth;
        }
        tryBtn.draw();

        if(!exitBtn){
          exitBtn=new ImageButton(images.exitBtn, LOGICAL_W/2, LOGICAL_H/2+150);
          exitBtn.scale=Math.min(420, LOGICAL_W*0.56)/images.exitBtn.naturalWidth;
        }
        exitBtn.draw();
      }

      function tick(){
        requestAnimationFrame(tick);
        const t=now(); if(!lastTs) lastTs=t;
        const dt=Math.min(0.05,(t-lastTs)/1000); lastTs=t;

        if(state===STATES.COVER) drawCover();
        else if(state===STATES.PLAY){ if(running) updatePlay(dt); drawPlay(); }
        else if(state===STATES.GAMEOVER) drawGameOver();
      }

      (async function start(){
        fitCanvas();
        await preload();
        lastTs=now(); tick();
      })();
    })();
  </script>
</body>
</html>
