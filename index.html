<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TAP-TAP RIALO</title>
  <style>
    :root { --fg:#e7edf5; }
    html,body{
      margin:0;padding:0;height:100%;background:#000;color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      overflow:hidden;touch-action:none;-webkit-user-select:none;user-select:none;
    }
    #wrap{position:fixed;inset:0;display:grid;place-items:center;background:#000;}
    canvas{background:#0b0e12;image-rendering:crisp-edges;image-rendering:pixelated;}
  </style>
</head>
<body>
  <div id="wrap"><canvas id="game" width="720" height="1280"></canvas></div>

  <script>
  (function(){
    // ===== LOGICAL CANVAS =====
    const W=720, H=1280;
    const ASSETS_PATH="./";

    // ===== ASSETS =====
    const ASSETS={
      cover:"cover-bg.png",
      bg:"bg-game.png",
      startBtn:"btn-start.png",
      tryBtn:"btn-tryagain.png",
      exitBtn:"btn-exit.png",
      coinIdle:"coin.png",
      coinFlip:"flip-coin.png",  // 3 frame horizontal
      bombIdle:"bomb.png",
      bombFlip:"flip-bomb.png"   // 3 frame horizontal
    };
    const BGM_FILE="bgm.mp3";

    // ===== STATES =====
    const STATES={COVER:0, PLAY:1, GAMEOVER:2};
    let state=STATES.COVER;

    // ===== CANVAS =====
    const canvas=document.getElementById('game');
    const ctx=canvas.getContext('2d');
    function fit(){
      const dpr=Math.max(1,devicePixelRatio||1);
      const s=Math.min(innerWidth/W, innerHeight/H);
      canvas.style.width=(W*s|0)+"px";
      canvas.style.height=(H*s|0)+"px";
      canvas.width=(W*dpr|0); canvas.height=(H*dpr|0);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    addEventListener('resize',fit);

    // ===== HELPERS =====
    const now=()=>performance.now();
    const rand=(a,b)=>a+Math.random()*(b-a);
    function loadImage(src){
      return new Promise((res,rej)=>{
        const i=new Image();
        i.onload=()=>res(i); i.onerror=rej; i.src=ASSETS_PATH+src;
      });
    }

    // ===== PRELOAD =====
    const images={};
    const bgm=new Audio(ASSETS_PATH+BGM_FILE); bgm.loop=true; bgm.volume=0.35;
    async function preload(){
      await Promise.all(Object.entries(ASSETS).map(async([k,v])=>{
        images[k]=await loadImage(v);
      }));
    }

    // ===== BUTTON =====
    class ImageButton{
      constructor(img,x,y){this.img=img;this.x=x;this.y=y;this.scale=1;
        this.w=img.naturalWidth; this.h=img.naturalHeight;}
      draw(){const w=this.w*this.scale,h=this.h*this.scale;
        ctx.drawImage(this.img,this.x-w/2,this.y-h/2,w,h);}
      hit(px,py){const w=this.w*this.scale,h=this.h*this.scale;
        return px>=this.x-w/2 && px<=this.x+w/2 && py>=this.y-h/2 && py<=this.y+h/2;}
    }

    // ===== OBJECT =====
    class Falling{
      constructor(type,x,spd){
        this.type=type; this.x=x; this.y=-80; this.vy=spd; this.r=64; this.alive=true;
        this.spawnTime=now();
        this.idleImg=(type==='coin')?images.coinIdle:images.bombIdle;
        this.flipImg=(type==='coin')?images.coinFlip:images.bombFlip;
        this.flipCols=3; this.flipFPS=10;
      }
      getFrame(){
        const t=now()-this.spawnTime;
        if(t<150) return {img:this.idleImg,sx:0,sy:0,sw:this.idleImg.naturalWidth,sh:this.idleImg.naturalHeight};
        const frame=Math.floor((t-150)/(1000/this.flipFPS))%this.flipCols;
        const sw=this.flipImg.naturalWidth/this.flipCols, sh=this.flipImg.naturalHeight;
        return {img:this.flipImg,sx:frame*sw,sy:0,sw,sh};
      }
      update(dt){
        this.y+=this.vy*dt;
        if(this.y - this.r > H){
          // JATUH MELEWATI BAWAH
          this.alive=false;
          if(this.type==='coin'){ // koin terlewat → nyawa -1
            lives=Math.max(0,lives-1);
          }
          // bomb terlewat → tidak ada efek
        }
      }
      draw(){
        const f=this.getFrame(); const size=128;
        ctx.drawImage(f.img,f.sx,f.sy,f.sw,f.sh,this.x-size/2,this.y-size/2,size,size);
      }
      contains(px,py){const dx=px-this.x,dy=py-this.y;return dx*dx+dy*dy<=this.r*this.r;}
    }

    // ===== GAME VAR =====
    let startBtn, tryBtn, exitBtn;
    let objects=[], score=0, lives=3;
    let elapsed=0; // timer maju
    let lastTs=0;
    let spawnAccum=0;
    let running=false;

    function resetGame(){
      objects=[]; score=0; lives=3; elapsed=0; lastTs=now(); spawnAccum=0; running=true;
      try{ bgm.currentTime=0; bgm.play(); }catch{}
    }
    function stopMusic(){ try{ bgm.pause(); }catch{} }

    // ===== INPUT =====
    function localPoint(ev){
      const r=canvas.getBoundingClientRect();
      const sx=W/r.width, sy=H/r.height;
      const c= ev.touches? ev.touches[0] : ev;
      return {x:(c.clientX-r.left)*sx, y:(c.clientY-r.top)*sy};
    }
    function onPointerDown(ev){
      const p=localPoint(ev);
      if(state===STATES.COVER){
        if(startBtn && startBtn.hit(p.x,p.y)){ state=STATES.PLAY; resetGame(); ev.preventDefault(); }
      }else if(state===STATES.PLAY){
        for(let i=objects.length-1;i>=0;i--){
          const o=objects[i];
          if(o.contains(p.x,p.y)){
            if(o.type==='coin'){ score+=1; }
            else { // klik bomb → nyawa -1
              lives=Math.max(0,lives-1);
            }
            o.alive=false;
            if(lives<=0){ state=STATES.GAMEOVER; running=false; stopMusic(); }
            ev.preventDefault();
            return;
          }
        }
      }else if(state===STATES.GAMEOVER){
  if(tryBtn && tryBtn.hit(p.x,p.y)){
    state=STATES.PLAY;
    resetGame();
    ev.preventDefault();
  }
  if(exitBtn && exitBtn.hit(p.x,p.y)){
    state=STATES.COVER;
    running=false;
    objects=[]; score=0; lives=3; elapsed=0; // reset penuh
    stopMusic();
    ev.preventDefault();
  }
}
    canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
    canvas.addEventListener('touchstart', onPointerDown, {passive:false});

    // ===== SPAWN / DIFFICULTY =====
    function difficulty(){
      // Semakin lama → makin sulit
      const speedBase = 320 + elapsed * 8;       // kecepatan jatuh
      const spawnRate = Math.max(0.30, 0.90 - elapsed * 0.01); // jeda spawn
      return {speedBase, spawnRate};
    }
    function spawnOne(){
      const {speedBase}=difficulty();
      const margin=64, x=rand(margin, W-margin);
      const type=(Math.random()<0.8)?'coin':'bomb';
      const obj=new Falling(type,x,rand(speedBase*0.9, speedBase*1.2));
      objects.push(obj);
    }

    // ===== UPDATE =====
    function updatePlay(dt){
      elapsed += dt;
      const {spawnRate}=difficulty();

      spawnAccum += dt;
      while (spawnAccum >= spawnRate){
        spawnAccum -= spawnRate;
        spawnOne();
      }

      for(const o of objects) o.update(dt);
      objects = objects.filter(o=>o.alive && o.y - o.r <= H+2);

      if(lives<=0){ state=STATES.GAMEOVER; running=false; stopMusic(); }
    }

    // ===== RENDER =====
    function drawCover(){
      const bg=images.cover;
      const s=Math.max(W/bg.naturalWidth, H/bg.naturalHeight);
      const w=bg.naturalWidth*s, h=bg.naturalHeight*s;
      ctx.drawImage(bg,(W-w)/2,(H-h)/2,w,h);

      if(!startBtn){
        startBtn=new ImageButton(images.startBtn, W/2, H*0.8);
        startBtn.scale=Math.min(520, W*0.7)/images.startBtn.naturalWidth;
      }
      startBtn.draw();
    }

    function drawHUD(){
      ctx.save();
      // Skor
      ctx.font="bold 36px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.textAlign="right";
      ctx.fillStyle="#000a"; ctx.fillRect(W-240,20,220,80);
      ctx.fillStyle="#fff"; ctx.fillText(`$ RIALO: ${score}`, W-30, 60);
      // Nyawa
      const r=14,g=10,sx=W-200,sy=90;
      for(let i=0;i<3;i++){
        ctx.beginPath(); ctx.arc(sx+i*(r*2+g), sy, r, 0, Math.PI*2);
        ctx.fillStyle = (i<lives) ? "#ff4040" : "#444"; ctx.fill();
      }
      // Timer naik
      ctx.textAlign="center";
      ctx.fillStyle="#000a"; ctx.fillRect(W/2-140,20,280,64);
      ctx.fillStyle="#fff"; ctx.font="bold 44px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.fillText(`${Math.floor(elapsed)}s`, W/2, 68);
      ctx.restore();
    }

    function drawPlay(){
      const bg=images.bg;
      const s=Math.max(W/bg.naturalWidth, H/bg.naturalHeight);
      const w=bg.naturalWidth*s, h=bg.naturalHeight*s;
      ctx.drawImage(bg,(W-w)/2,(H-h)/2,w,h);

      for(const o of objects) o.draw();
      drawHUD();
    }

    function drawGameOver(){
      drawPlay();
      ctx.fillStyle="rgba(0,0,0,0.55)"; ctx.fillRect(0,0,W,H);

      const pw=540, ph=420, px=(W-pw)/2, py=(H-ph)/2;
      ctx.fillStyle="#12161c"; ctx.strokeStyle="#ffffff22"; ctx.lineWidth=2;
      ctx.fillRect(px,py,pw,ph); ctx.strokeRect(px,py,pw,ph);
      ctx.fillStyle="#fff"; ctx.textAlign="center";
      ctx.font="700 54px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.fillText("Game Over", W/2, py+80);
      ctx.font="700 36px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.fillText(`$ RIALO terkumpul: ${score}`, W/2, py+140);
      ctx.font="500 24px system-ui,-apple-system,Segoe UI,Roboto";
      ctx.fillText(`Waktu bermain: ${Math.floor(elapsed)} detik`, W/2, py+180);

      if(!tryBtn){
        tryBtn=new ImageButton(images.tryBtn, W/2, H/2+40);
        tryBtn.scale=Math.min(520, W*0.7)/images.tryBtn.naturalWidth;
      }
      tryBtn.draw();

      if(!exitBtn){
        exitBtn=new ImageButton(images.exitBtn, W/2, H/2+170);
        exitBtn.scale=Math.min(420, W*0.56)/images.exitBtn.naturalWidth;
      }
      exitBtn.draw();
    }

    // ===== MAIN LOOP =====
    let last=0;
    function tick(){
      requestAnimationFrame(tick);
      const t=now(); if(!last) last=t;
      const dt=Math.min(0.05,(t-last)/1000); last=t;

      if(state===STATES.COVER) drawCover();
      else if(state===STATES.PLAY){ if(running) updatePlay(dt); drawPlay(); }
      else if(state===STATES.GAMEOVER) drawGameOver();
    }

    // ===== START =====
    (async function start(){
      fit(); await preload(); lastTs=now(); tick();
    })();

  })();
  </script>
</body>
</html>
